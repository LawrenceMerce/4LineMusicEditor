# 4LineMusicEditor
一个简单的四声部音乐写作程序  
默认适用windows 自带的midi音色  
可通过下载现有音色库，选择.sf文件来更改音色

# SATB Arranger v3.3 使用说明书

> **版本**：v3.3（卷帘 + 文本属性 + 发音法 + 连音）  
> **适用系统**：Windows / macOS / Linux（已在 Windows 重点适配）  
> **主要依赖**：Python 3.9+、`pygame`、`numpy`、`midiutil`（可选：`pyfluidsynth`）

---

## 目录

- [功能概览](#功能概览)
- [安装与准备](#安装与准备)
- [启动与快速上手](#启动与快速上手)
- [界面与操作](#界面与操作)
- [SATB 文本语法](#satb-文本语法)
- [播放后端说明](#播放后端说明)
- [导出 MIDI](#导出-midi)
- [自动配器（和弦→四声部）](#自动配器和弦四声部)
- [规则检查](#规则检查)
- [常见问题（FAQ）](#常见问题faq)
- [示例与资源](#示例与资源)
- [已知限制与路线图](#已知限制与路线图)
- [版本历史](#版本历史)
- [许可证](#许可证)

---

## 功能概览

- **四声部（SATB）编曲**：文本/钢琴卷帘双视图，随时互通。  
- **文本音符属性**：
  - **力度**：`dyn=pp/p/mp/mf/f/ff` 或 `vel=1..127`；互相映射。  
  - **踏板**：`ped=on/off`（全局生效）。  
  - **发音法 articulation**：`art=stacc/ten/accent/marcato`（简写 `{stacc}` 等）。  
  - **连音 tie**：`tie=start/cont/end`（简写 `{tie}` 表示 start）。  
- **卷帘编辑**：拖动移动、抓右端改时值、Ctrl+拉伸“推挤”、Shift+拖改变力度；底部拖拽绘制踏板区间。  
- **播放后端**：
  - **SoundFont (FluidSynth)**（推荐，高保真）：加载 `.sf2`。  
  - **Sampler (WAV)**：用真实乐器采样（自动移调）。  
  - **System MIDI**：系统自带 MIDI 合成器。  
- **导出 MIDI**：写入 **Tempo** 与 **CC64 踏板**，四声部分轨、分通道。  
- **规则检查**：音域越界 / 声部交叉 / 并行五度八度。  
- **自动配器**：从和弦序列生成一段基础 SATB。

---

## 安装与准备

### 1) 安装 Python 依赖

```bash
pip install pygame numpy midiutil
# 可选：若使用 SoundFont 播放（推荐）
pip install pyfluidsynth
```

> Windows 上安装 `pyfluidsynth` 后，还需让系统能找到 **FluidSynth DLL**：  
>
> - 最简单：安装预编译的 FluidSynth，并把 `bin` 目录加入环境变量 `FLUIDSYNTH_BIN`，或放在 `C:\tools\fluidsynth\bin`。  
> - 程序会自动尝试 `os.add_dll_directory(FLUIDSYNTH_BIN)` 或 `C:\tools\fluidsynth\bin`。

### 2) 准备音源（至少选一种）

- **SoundFont**：准备任意 `.sf2`（如 `A320U.sf2`、`TimGM6mb.sf2`、`Scc1t2.sf2` 等）。  
- **采样器（可选）**：准备一组 `.wav`，文件名 **结尾**包含标准音名：`...C4.wav`、`...D#4.wav`、`...Db3.wav` 等，大小写均可。  
  - 例如：`piano_C4.wav`、`grand_D#4.wav` 都可匹配（程序只看文件名末尾的 `C4.wav` 模式）。

---

## 启动与快速上手

1. 运行 `music_v3_3.py`：

   ```bash
   python music_v3_3.py
   ```

2. 顶部工具条：

   - 设置 **BPM**、**移调**、**网格 (1/4, 1/8, 1/16)**。  
   - 选择 **音频后端**。  
   - 若用 SoundFont：点击 **“选择 SoundFont”** 指定 `.sf2`。  
   - 若用采样器：点击 **“选择采样目录”** 指定你的 `.wav` 集。  

3. 文本区（S/A/T/B）已经内置一段 Demo（含发音法/连音/踏板）。  

4. 点击 **“▶ 播放”**。失败时查看状态栏提示或 FAQ。

---

## 界面与操作

### 卷帘（Piano Roll）

- **左键拖动音块**：移动音高/起点。  
- **抓右端白色把手**：改变时值。  
- **Ctrl + 抓右端拉伸**：**推挤**后续音符（保持相对关系）。  
- **双击空白**：在当前声部插入一个 1 拍的新音。  
- **右键音块**：删除该音。  
- **Shift + 拖动（已选音）**：改变该音力度（上下拖动）。  
- **Delete**：删除选中音。  
- **延音踏板区（卷帘底部绿色区域）**：
  - 左键拖出新踏板区间；
  - 拖动左右边缘调整范围；
  - 右键区间删除。

> **注意**：当前版本中，在卷帘里修改后，写回文本时仅保留 `dyn/vel/ped`，**不会回写发音法/连音** 标记（见“路线图”）。

### 文本区

- 四个文本框对应 **S/A/T/B**。  
- 编辑后点击 **“刷新/检查”** 同步到卷帘并做规则检查。  
- 也可直接点击 **“▶ 播放”**，播放时会以 **文本** 为准构建事件（含发音法与连音）。

---

## SATB 文本语法

**基本形态**：

```
音名 + 时值 [ + 属性块 ]
```

### 1) 音名

- 音符：`C4`、`D#5`、`Eb3`、`A-1`（支持 `#`、`b`、负八度）。  
- 休止：以 `R` 开头，如 `Rq`、`Rh`、`R0.5`。

### 2) 时值

- 记号：`w=4, h=2, q=1, e=1/2, s=1/4, t=1/8`，支持附点（如 `h.` = 3 拍）。  
- 数值：任意小数拍，如 `C40.75`。

### 3) 属性块 `{...}`

- **力度**：`dyn=pp|p|mp|mf|f|ff` 或 `vel=1..127`。  
- **踏板**：`ped=on|off`（被解析为 **全局 CC64** 区间；可写在任意声部的任意 token 上）。  
- **发音法**：`art=stacc|ten|accent|marcato`  
  - 简写 `{stacc}`、`{ten}`、`{accent}`、`{marcato}`。  
  - 播放时对“有效长度/力度”有如下影响：  
    - `stacc`：长度 ×0.55；  
    - `ten`：长度 ×0.98；  
    - `accent`：长度 ×0.90，力度 ×1.20；  
    - `marcato`：长度 ×0.75，力度 ×1.25。  
- **连音 tie**：`tie=start|cont|end`（简写 `{tie}` = `start`）  
  - 同一音高的连续 token 会被**合并**成一条音，避免断奏；  
  - 当发生合并时，**不再缩短长度**（忽略 stacc 等缩短），确保真正连起来。

### 4) 小节线

- `|` 仅用于视觉分隔；程序会在回写时每 4 拍插入 `|`（当前拍号固定 4/4）。

### 5) 示例

```
C5q{dyn=mp,ped=on} D5e{stacc} E5e F5q{accent} G5q |
G5h{tie=start} G5q{tie=end} Rq{ped=off} |
A5q{ten} G5q F5q E5q | D5h C5h{dyn=p}
```

---

## 播放后端说明

### SoundFont (FluidSynth) —— 推荐

- 选择 `.sf2` 后点击 **播放**。  
- Windows：如出现 `FileNotFoundError: ...\fluidsynth\bin`，请：  
  1) 安装 FluidSynth；  
  2) 把其 `bin` 路径（含 `libfluidsynth-*.dll`）加入环境变量 `FLUIDSYNTH_BIN` 或放到 `C:\tools\fluidsynth\bin`；  
  3) 重新运行程序并在“音频后端”中保持 `SoundFont (FluidSynth)`。

### Sampler (WAV)

- 点击 **“选择采样目录”**，程序会加载目录下所有 `*.wav`，按文件名末尾的 `C4.wav / D#4.wav / Db3.wav` 自动识别音高。  
- 若只提供几个音高，程序会做**高质量线性插值移调**。  
- 实时力度 → 播放音量。

### System MIDI

- 无需音源，但音色由系统决定；在部分 Windows 设备上存在音质/延迟限制。

> 播放过程中可随时点击 **■ 停止**；再次播放会重新构建事件序列。

---

## 导出 MIDI

- 点击 **“💾 导出 MIDI”**，生成 `*.mid`：  
  - 轨道 0：Tempo + 全局 **CC64**（踏板）。  
  - 轨道 1..4：S/A/T/B 四个声部（通道 0..3）。  
  - 音符使用**文本解析后的“有效时长/力度”**（发音法/连音已生效）。  
- 导出的 MIDI 可直接导入任意 DAW 或打谱软件（MuseScore / Dorico / Sibelius 等）。

---

## 自动配器（和弦→四声部）

- 在“从和弦自动生成”区域：  
  - **和弦**（空格分隔，可含 `maj7/m7/7/6/dim/aug` 等）：`C F G7 C | Am Dm G7 C`  
  - **时值**（与和弦一一对应）：`q q q q q q q q`  
- 点击 **“覆盖填入”** 或 **“在尾部追加”**。  
- 生成结果可作为草稿，再用文本或卷帘细修。

---

## 规则检查

- **音域越界**：各声部超出合理范围（默认：S 60–84、A 55–77、T 48–69、B 40–60）。  
- **声部交叉**：S 低于 A、A 低于 T、T 低于 B。  
- **并行五度/八度**：相邻声部的连续运动导致的平行纯 5/8 度。  
- 结果显示于右侧表格，点击可让卷帘滚动到对应位置。

---

## 常见问题（FAQ）

**Q1：播放没声音？**  
A：依次检查：  

1. 音频后端是否选择正确（例如先试 **System MIDI** 以排除问题）。  
2. 若使用 **SoundFont**，是否选中了 `.sf2`；Windows 上是否已正确配置 FluidSynth DLL。  
3. 若使用 **Sampler**，目录下是否有能匹配的音名文件（末尾 `C4.wav` 等）。

**Q2：必须先点“停止”再“播放”才有声？**  
A：v3.3 已在启动/停止流程中规避该问题；若仍有偶发，请在播放前手动点一次“■ 停止”。

**Q3：卷帘改动后文本丢了 `art/tie`？**  
A：当前版本只回写 `dyn/vel/ped` 到文本（见“路线图”）。如需保持 `art/tie`，请优先在文本侧编辑。

**Q4：如何写踏板？**  
A：在任何声部的任意位置写 `{ped=on}` / `{ped=off}`，程序会合并成全局区间并写入 CC64。

**Q5：采样器命名规则？**  
A：文件名需要在**结尾**匹配 `C4.wav` / `D#4.wav` / `Db3.wav` 等，前缀随意：`piano_C4.wav` 也可。

**Q6：延迟/爆音？**  
A：降低 BPM 或简化和声密度；Sampler 可尝试减少同时发声数；确保系统采样率在 44.1kHz。

---

## 示例与资源

- **内置 Demo**：程序启动即加载（含发音法/连音/踏板）。  
- **致爱丽丝（约 100 小节）SATB 文本**：  
  下载：[`fur_elise_satb_100bars.txt`](sandbox:/mnt/data/fur_elise_satb_100bars.txt)  
  用法：将文件中的四段分别粘贴进 S/A/T/B 文本框，点击“播放”。

---

## 已知限制与路线图

- 目前拍号固定为 **4/4**；回写文本时每 4 拍插入 `|`。  
- 卷帘回写**不保留** `art/tie`（仅 `dyn/vel/ped`）。  
- 暂无连音线/发音法的卷帘可视标记。  
- 不支持三连音/摆动（swing）。

**计划中的改进**：  

- 自定义拍号（3/8、6/8、3/4 …）与“按文本 `|` 硬分小节”。  
- `art/tie` 持久化到内部模型，卷帘修改后也能回写到文本。  
- 卷帘显示 `art/tie` 的小图标/底纹。  
- 量化/人性化/摇摆、力度曲线编辑。  
- 每声部独立音色/Program 设定，MusicXML 导出。

---

## 版本历史

- **v3.3**：新增 `art` & `tie` 文本语法；播放/导出生效；demo 升级。  
- **v3.2**：将 `dyn/vel/ped` 写进文本；踏板 CC；卷帘 ↔ 文本互通。  
- **v3.1**：卷帘编辑重构（推挤、力度拖动、踏板区）。  
- **v3.0**：OOP 架构、三种音频后端。

---

## 许可证

本工具示例代码与本说明书以 **MIT License** 授权。可自由用于学习、研究与项目集成。

---

**Have fun & make music!** 🎵
